# Alice-Engine - Claude Code Instructions

## Project Overview

**Alice-Engine** (Adversarial Lineup Inference & Composition Engine) is a Python ML service that predicts chess team compositions and optimizes lineups for French Chess Federation (FFE) interclub competitions.

- **Version**: 0.1.0
- **Language**: Python 3.11+
- **Framework**: FastAPI + Uvicorn (async)
- **ML**: CatBoost, XGBoost, scikit-learn
- **Optimization**: OR-Tools
- **Database**: MongoDB (read-only, shared with chess-app)

## Tech Stack

| Category | Technologies |
|----------|--------------|
| API | FastAPI 0.109+, Pydantic 2.5+ |
| ML | CatBoost 1.2.7+, XGBoost 2.1+, scikit-learn 1.4+ |
| Data | pandas, numpy, pyarrow, Motor (async MongoDB) |
| Optimization | OR-Tools 9.8 |
| Quality | ruff, mypy, bandit, pytest, pre-commit |

## Project Structure

```
alice-engine/
├── app/                    # Controller Layer (FastAPI)
│   ├── main.py            # Entry point with lifespan
│   ├── config.py          # Settings (env vars)
│   └── api/
│       ├── routes.py      # HTTP endpoints
│       └── schemas.py     # Pydantic models
├── services/              # Service Layer (business logic)
│   ├── inference.py       # ALI - Lineup prediction
│   ├── composer.py        # CE - Lineup optimization
│   └── data_loader.py     # Repository (MongoDB/Parquet)
├── tests/                 # pytest tests
├── scripts/               # Utilities & ML pipelines
├── models/                # ML model artifacts (.cbm, .joblib)
├── docs/                  # Documentation (ISO, API, architecture)
└── graphs/                # Generated architecture SVGs
```

## Commands

```bash
# Installation
make install      # Install dependencies
make hooks        # Install pre-commit hooks

# Quality
make lint         # Ruff linting
make format       # Code formatting
make typecheck    # MyPy strict checking
make security     # Bandit security scan
make quality      # All above

# Testing
make test         # Run pytest
make test-cov     # Tests + coverage (>80% required)

# Development
make dev          # Start FastAPI server (localhost:8000)
make all          # Full validation pipeline
```

## Coding Conventions

### Architecture
- **Layered**: Controller -> Service -> Repository
- **Async-first**: Use `async/await` for I/O operations
- **SRP**: Each layer has single responsibility

### Naming
- `snake_case` for functions/variables
- `PascalCase` for classes
- `UPPERCASE` for constants
- FFE domain terms: `ffe_id`, `club_id`, `board` (1-8)

### Type Hints
Full type annotations required on all functions:
```python
def predict_lineup(
    opponent_club_id: str,
    round_number: int,
) -> list[PlayerProbability]:
```

### Code Style
- Line length: 100 characters
- Docstrings: Google style
- Comments: Explain "why" not "what"
- ISO standard references in comments when applicable

### Commit Messages
Conventional Commits (Commitizen):
```
feat(ffe): implement FFE rules as ML features
fix(hooks): move report generation to manual stage
docs(project): add training progress reports
```

## Key Components

### ALI - Adversarial Lineup Inference
`services/inference.py` - Predicts opponent's team composition using CatBoost/XGBoost with probabilistic scenarios.

### CE - Composition Engine
`services/composer.py` - Optimizes own lineup using OR-Tools assignment solver with Elo-based expected scores (K=400).

### API Endpoints
- `POST /api/v1/predict` - Main prediction endpoint
- `GET /api/v1/models/{club_id}` - Model info
- `POST /api/v1/train` - Training trigger (API key protected)
- `GET /health` - Health check

## Environment Variables

Required in `.env` (see `.env.example`):
- `MONGODB_URI` - MongoDB Atlas connection
- `MONGODB_DATABASE` - Database name (chess-app)
- `API_KEY` - For protected endpoints
- `MODEL_PATH` - ML model directory

## ISO Compliance

This project follows ISO standards:
- **ISO 42010**: Architecture documentation
- **ISO 5055**: Code quality (ruff)
- **ISO 27001**: Security (secrets in env vars)
- **ISO 25012**: Data quality validation
- **ISO 29119**: Testing standards

## Important Notes

1. **Pre-commit hooks**: Always run `make hooks` after cloning
2. **Coverage**: Tests must maintain >80% coverage
3. **MongoDB**: Read-only access to shared chess-app database
4. **Dataset**: `dataset_alice/` symlink to FFE data (2.4 GB, not in git)
5. **Generated files**: Run `make reports` before pushing (graphs, ISO docs)

## Documentation

- `docs/requirements/CDC_ALICE.md` - Requirements specification
- `docs/requirements/REGLES_FFE_ALICE.md` - FFE rules
- `docs/architecture/ARCHITECTURE.md` - Architecture details
- `docs/api/API_CONTRACT.md` - API specification
- `docs/development/CONTRIBUTING.md` - Contribution guide
