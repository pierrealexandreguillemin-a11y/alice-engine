# =============================================================================
# Pre-commit Hooks Configuration - ALICE Engine
# =============================================================================
#
# ISO STANDARDS COMPLIANCE:
# - ISO/IEC 5055:2021    Code Quality (automated weakness detection)
# - ISO/IEC 25010:2023   System Quality (maintainability, reliability)
# - ISO/IEC 27001:2022   Information Security (secrets, vulnerabilities)
# - ISO/IEC 27034:2011   Application Security (OWASP, secure coding)
# - ISO/IEC 29119:2022   Software Testing (coverage, test quality)
# - ISO/IEC 42010:2022   Architecture Description (dependencies, coupling)
# - ISO/IEC 15289:2019   Documentation (traceability, audit records)
#
# ML/AI SPECIFIC:
# - ISO/IEC 42001:2023   AI Management System (model governance)
# - ISO/IEC 5259:2024    Data Quality for ML (lineage, validation)
#
# Usage:
#   pre-commit install
#   pre-commit install --hook-type commit-msg --hook-type pre-push
#
# Manual hooks:
#   pre-commit run --hook-stage manual architecture-health
#   pre-commit run --hook-stage manual generate-graphs
#   pre-commit run --hook-stage manual update-iso-docs
#
# =============================================================================

default_stages: [pre-commit]
fail_fast: false

repos:
  # ============================================================================
  # STAGE: PRE-COMMIT
  # Focus: Code quality gates before commit (fast feedback)
  # ============================================================================

  # --------------------------------------------------------------------------
  # SECURITY: Secret Detection (ISO 27001 - A.9 Access Control)
  # CWE-798: Use of Hard-coded Credentials
  # --------------------------------------------------------------------------
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.4
    hooks:
      - id: gitleaks
        name: "ISO 27001 | Secrets Detection"
        description: "Detect hardcoded secrets, API keys, passwords (CWE-798)"

  # --------------------------------------------------------------------------
  # CODE QUALITY: Linting + Security Rules (ISO 5055 + ISO 27034)
  # - Ruff rules S*: flake8-bandit (security)
  # - Ruff rules B*: flake8-bugbear (bugs)
  # - Ruff rules C4*: comprehensions
  # - Ruff rules UP*: pyupgrade
  # --------------------------------------------------------------------------
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.5.0
    hooks:
      - id: ruff
        name: "ISO 5055 | Lint + Security Analysis"
        description: "Static analysis: style, bugs, security (CWE detection)"
        args: [--fix, --exit-non-zero-on-fix]
      - id: ruff-format
        name: "ISO 5055 | Code Formatting"
        description: "Consistent code style (maintainability)"

  # --------------------------------------------------------------------------
  # TYPE SAFETY: Static Type Checking (ISO 5055 - Reliability)
  # Prevents runtime type errors, improves code documentation
  # --------------------------------------------------------------------------
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.10.0
    hooks:
      - id: mypy
        name: "ISO 5055 | Type Safety Analysis"
        description: "Static type checking for reliability"
        additional_dependencies: [types-requests, pydantic]
        args: [--ignore-missing-imports]
        exclude: ^tests/

  # --------------------------------------------------------------------------
  # DATA INTEGRITY: Config File Validation (ISO 25012 - Data Quality)
  # Ensures configuration files are well-formed
  # --------------------------------------------------------------------------
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: check-yaml
        name: "ISO 25012 | YAML Validation"
      - id: check-json
        name: "ISO 25012 | JSON Validation"
      - id: check-toml
        name: "ISO 25012 | TOML Validation"
      - id: check-added-large-files
        name: "ISO 27001 | Large File Detection"
        description: "Prevent accidental commit of large files (data leakage)"
        args: ['--maxkb=1000']
      - id: check-merge-conflict
        name: "ISO 12207 | Merge Conflict Detection"
        description: "Ensure clean merge state"
      - id: debug-statements
        name: "ISO 5055 | Debug Statement Detection"
        description: "Remove debug code before commit"

  # ============================================================================
  # STAGE: COMMIT-MSG
  # Focus: Traceability and documentation (ISO 15289)
  # ============================================================================

  # --------------------------------------------------------------------------
  # DOCUMENTATION: Conventional Commits (ISO 15289 - Traceability)
  # Enables automatic changelog generation and semantic versioning
  # --------------------------------------------------------------------------
  - repo: https://github.com/commitizen-tools/commitizen
    rev: v3.27.0
    hooks:
      - id: commitizen
        name: "ISO 15289 | Conventional Commit Format"
        description: "Enforce traceable commit messages"
        stages: [commit-msg]

  # ============================================================================
  # STAGE: PRE-PUSH
  # Focus: Quality gates before sharing code (comprehensive checks)
  # ============================================================================
  - repo: local
    hooks:
      # ------------------------------------------------------------------------
      # TESTING: Coverage Gate (ISO 29119 - Test Coverage)
      # ISO 29119-4: Test Techniques - Coverage measurement
      # Target: 80% (current: 55% progressive adoption)
      # ------------------------------------------------------------------------
      - id: pytest-cov
        name: "ISO 29119 | Test Coverage (70% min)"
        description: "Run tests with coverage measurement"
        entry: python
        args: [-m, pytest, tests/, -v, --tb=short, --cov=app, --cov=services, --cov=scripts, --cov-fail-under=70, -x]
        language: system
        pass_filenames: false
        stages: [pre-push]
        always_run: true

      # ------------------------------------------------------------------------
      # MAINTAINABILITY: Complexity Analysis (ISO 25010 - Maintainability)
      # Cyclomatic complexity: max B (11-20)
      # Average complexity: max A (1-5)
      # ------------------------------------------------------------------------
      - id: xenon
        name: "ISO 25010 | Cyclomatic Complexity"
        description: "Ensure maintainable code complexity"
        entry: python
        args: [-m, xenon, --max-absolute=B, --max-modules=B, --max-average=A, app/, services/]
        language: system
        pass_filenames: false
        stages: [pre-push]

      # ------------------------------------------------------------------------
      # SECURITY: Dependency Audit (ISO 27001 - Vulnerability Management)
      # Checks for known vulnerabilities in dependencies (CVE database)
      # ------------------------------------------------------------------------
      - id: pip-audit
        name: "ISO 27001 | Dependency Vulnerabilities"
        description: "Audit dependencies for known CVEs"
        entry: python
        args: [-m, pip_audit, --strict, --local]
        language: system
        pass_filenames: false
        stages: [pre-push]

  # ============================================================================
  # STAGE: MANUAL
  # Focus: Documentation and architecture artifacts (on-demand)
  # Run via: make graphs | make iso-docs | make reports
  # Or: pre-commit run --hook-stage manual <hook-id>
  # ============================================================================
  - repo: local
    hooks:
      # ------------------------------------------------------------------------
      # ARCHITECTURE: Health Score (ISO 42010 - Architecture Description)
      # Measures: coupling, cohesion, circular dependencies
      # Output: reports/architecture-health.json
      # ------------------------------------------------------------------------
      - id: architecture-health
        name: "ISO 42010 | Architecture Health Score"
        description: "Analyze coupling, cycles, dependencies"
        entry: python
        args: [-m, scripts.analyze_architecture]
        language: system
        pass_filenames: false
        stages: [manual]

      # ------------------------------------------------------------------------
      # ARCHITECTURE: Dependency Graphs (ISO 42010 - Architecture Views)
      # Generates visual dependency graphs for documentation
      # Output: graphs/dependencies.svg
      # ------------------------------------------------------------------------
      - id: generate-graphs
        name: "ISO 42010 | Dependency Graphs"
        description: "Generate architecture visualization"
        entry: python
        args: [-m, scripts.generate_graphs]
        language: system
        pass_filenames: false
        stages: [manual]

      # ------------------------------------------------------------------------
      # DOCUMENTATION: ISO Status Report (ISO 15289 - Quality Records)
      # Auto-generates implementation status for audits
      # Output: docs/iso/IMPLEMENTATION_STATUS.md
      # ------------------------------------------------------------------------
      - id: update-iso-docs
        name: "ISO 15289 | Implementation Status"
        description: "Update ISO compliance documentation"
        entry: python
        args: [-m, scripts.update_iso_docs]
        language: system
        pass_filenames: false
        stages: [manual]
